import streamlit as st
import requests
import random
import json

st.title("Comparison between Llama 3.1 8B and RAG system")
st.write("This chatbot compares responses from Meta's Llama 3.1 8B Instruct model on AwanLLM API and respoonse got doing RAG stored in the Neural Bridge 12000 dataset.")

api_token = st.secrets["awanllm"]["api_token"]
api_url = "https://api.awanllm.com/v1/chat/completions"
model_id = "Meta-Llama-3.1-8B-Instruct"

headers = {
    'Content-Type': 'application/json',
    'Authorization': f"Bearer {api_token}"
}

# Neural Bridge 12000 Sample Q&A
qa_dataset = {'What is the Berry Export Summary 2028 and what is its purpose?': 'The Berry Export Summary 2028 is a dedicated export plan for the Australian strawberry, raspberry, and blackberry industries. It maps the sectors’ current position, where they want to be, high-opportunity markets, and next steps. The purpose of this plan is to grow their global presence over the next 10 years.', 'What are some of the benefits reported from having access to Self-supply water sources?': 'Benefits reported from having access to Self-supply water sources include convenience, less time spent for fetching water and access to more and better quality water. In some areas, Self-supply sources offer important added values such as water for productive use, income generation, family safety and improved food security.', 'What are the unique features of the Coolands for Twitter app?': 'The unique features of the Coolands for Twitter app include Real-Time updates without the need for a refresh button, Avatar Indicator which shows small avatars on the title bar for new messages, Direct Link for intuitive and convenient link opening, Smart Bookmark to easily return to previous reading position, and User Level Notification which allows customized notification settings for different users.', "What is the main difference between the National Sample Survey (NSS) and the India Human Development Survey (IHDS) in terms of measuring India's inequality?": "The main difference between the NSS and the IHDS in terms of measuring India's inequality is that the NSS focused on consumption, that is, how much people actually consume, while the IHDS is based on income. The NSS was showing consistently lower rates of growth and higher poverty, while the IHDS revealed a higher level of inequality, similar to Latin American countries.", 'How did Gunnar Nelson win the fight against Zak Cummings at UFC Fight Night 46?': 'Gunnar Nelson won the fight against Zak Cummings at UFC Fight Night 46 by taking his opponent to the mat, seizing his back and locking in a rear-naked choke, forcing Cummings to tap with only twelve seconds of the second round remaining.', "What are some of the features of Fabiana Filippi's shirts and blouses?": "Fabiana Filippi's shirts and blouses are easily matched to different shapes, fabrics and colours. They are made from silk and cotton, and come in classic, slim and over cuts, in ultra-modern style. They are available in different lengths up to maxi lines, and come in men’s cut, Korean, V, round necks. They are suitable to wear during the day and at night.", 'How did Dan Foley feel about his portrayal on the Survivor TV show?': 'Dan Foley expressed his frustration about his portrayal on the Survivor TV show, stating that he was portrayed negatively and was surprised at how vitriolic the viewer response has been.', 'What is the lunch that Kim and Tony plan to have on Monday according to the context?': 'The New York Times’ Green Garlic Tabbouleh.', 'What is the reason for the closure of the comments section?': 'The comments section was shut down because the spam was getting out of control.', 'What are the five love and relationship podcasts mentioned in the context?': 'The five love and relationship podcasts mentioned in the context are "Love Is Like A Plant" with Sarah May Bates and Ellen Huerta, "Relationships! Let’s Talk About It" with Pripo Teplitsky, "Unqualified" with Anna Faris, "Confessions of a Terrible Husband" with Nick Pavlidis, and "Savage Lovecast" with Dan Savage.', 'Which two teams dropped out of the Primal Quest Utah race and what were their reasons for doing so?': 'The two teams that dropped out of the Primal Quest Utah race were Team Utah and Team xxTreme US. Team Utah quit due to blisters and exhaustion, while Team xxTreme US, which was largely comprised of Navy SEALs, had to withdraw due to injury.', "What does the word 'quantum' mean as per the context?": "The word 'quantum' means a quantity or amount, a portion, a large amount, or the smallest amount of something that can exist independently.", 'What is the purpose of the TRUGLO Picatinny Riser Mount?': 'The TRUGLO Picatinny Riser Mount is great for raising your red dot sight 1/2″ to be at the proper height for an ideal cheek weld.', 'What is the cost for credit union attendees under $35 million in assets to attend the conference?': 'The cost for credit union attendees under $35 million in assets to attend the conference is $495.', "What was the goal of the purge of training material regarding Islamic terrorism from law enforcement training under President Barack Obama's administration?": 'The goal was to banish any material that could be viewed as offensive to Muslims.', 'Who is the author of the book Kapow!?': 'The author of the book Kapow! is Adam Thirlwell.', 'What are some of the names Morganite is also known as?': "Morganite is also known as 'pink emerald' and 'rose beryl'.", 'What is the purpose of recycling concrete in construction?': 'Recycling concrete in construction helps in reutilizing the construction waste into new concrete, preserving landfill space, and reducing construction costs.', 'What are some features of the Womens Drew Argo Black Smooth Leather sandal?': 'The Womens Drew Argo Black Smooth Leather sandal features an adjustable strap, smooth uppers, a double depth thick removable cork footbed with memory foam, a tempered steel shank, and a broad, oblique toe shape.', 'What are some of the benefits of joining the SPJ Austin Student Chapter?': 'Joining the SPJ Austin Student Chapter gives students opportunities to deepen their journalistic knowledge outside of the classroom, connect with professionals in the industry, and attend various events.', 'What are some of the guidelines for disciplining a teenager?': "Some guidelines for disciplining a teenager include making expectations and rules clear, setting limits, not making rules arbitrarily, understanding that teenagers will mature through trial and error, rewarding constructive behavior, being a role model, being compassionate and patient during discussions, withdrawing privileges as a form of punishment without over-punishing, never using physical or mental torture, not giving in to tantrums or loud behavior, and not allowing guilt to cloud judgment. It's also important to remember that teenagers test the limits and to be compassionate and empathetic, remembering what it was like to be a teenager.", 'What is the purpose of the Virginia Environmental Education Certification program?': 'The Virginia Environmental Education Certification program sets a statewide standard for exemplary environmental education practice, encourages exploration of environmental education resources, and promotes professional growth. It is relevant for anyone who educates about an aspect of the environment, would like to strengthen their environmental or pedagogical expertise, and is passionate about professionalism in environmental education.', 'Who administers the World Heritage List where the Ancient Ohio Earthworks are being nominated?': 'The United Nations Educational, Scientific, and Cultural Organization (UNESCO) administers the World Heritage List.', 'When did Pope Benedict XVI announce his resignation?': 'Pope Benedict XVI announced his resignation on February 11, 2013.', 'What is the license under which "Fat and Not Afraid" by JeninCanada is licensed?': '"Fat and Not Afraid" by JeninCanada is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.', "Who is the designer of this year's Southern Living Idea House?": 'Bunny Williams.', 'When was the new village hall opened after a 15-year fundraising drive?': 'The new village hall was opened in 2008.', 'Who is the CEO of Franklin Templeton Investments?': 'The CEO of Franklin Templeton Investments is Gregory Johnson.', 'Can PXI-8512 modules be used to send and receive data with CAN protocol between two PXI 8880 controllers?': 'Yes, you can use CAN to share data between your controllers.', 'What is the main conflict in the third book of the Arcana Chronicles by Kresley Cole?': 'The main conflict in the third book of the Arcana Chronicles by Kresley Cole is that Evie has to save Jack who is threatened by two of the most horrific Arcana, The Lovers. To defeat them, Evie, Jack, and Death might have to ally, which could lead to internal conflicts.', 'Who is the soprano featured in duets with Roberto Alagna in the album "My Life Is An Opera"?': 'The soprano featured in duets with Roberto Alagna in the album "My Life Is An Opera" is Aleksandra Kurzak.', 'What are the features of the STEM Teacher’s Toolkits provided by CSD Learns?': 'The STEM Teacher’s Toolkits provided by CSD Learns are easy to implement online or in-person, feature deaf and hard of hearing role models, and provide several weeks’ worth of lessons in ASL. Each free toolkit has videos, interactive activities, quizzes and more.', 'Who granted the team access for the photoshoot at Blenheim Palace?': 'His Grace, The Duke of Marlborough granted the team access for the photoshoot at Blenheim Palace.', 'Who are the characters in Wuthering Heights that display a "diseased mind" and a "diseased body"?': 'The characters in Wuthering Heights that display a "diseased mind" are Heathcliff and Catherine. Heathcliff\'s mind is "diseased" due to his heartbreak and suffering from not being able to be with Catherine, which leads him to seek revenge. Catherine\'s mind is also "diseased" due to her overwhelming love for Heathcliff and the societal pressures that prevent them from being together. The characters that represent the "diseased body" are Catherine, due to her mental suffering being closely linked with her physical suffering, and Isabella, whose body is bruised due to abuse from Heathcliff.', "What are the 5 ways to make your Mum's day special according to the context?": "The 5 ways to make your Mum's day special are: 1. Spend quality time with her and have a good old chat. 2. Go on a road trip together. 3. Make her a homemade gift such as a card, art piece, poem, story, movie, photo collage, or a playlist of her favorite songs. 4. Do something you love with your Mum like dance, yoga, art, cycling. 5. Tell her you love her, appreciate all she has done for you and that you value her wisdom.", "What are Dr. Zgarrick's research interests?": "Dr. Zgarrick's research interests are in pharmacist workforce issues, professional service development, and the use of evidence-based medicine by pharmacists.", 'What did Barbara Coombs Lee suggest to help more people die in peace?': 'Barbara Coombs Lee suggested that to help more people die in peace we need to “redefine the standard of care at end of life.”', "What sequence of events led to the tragedy in a Chili's parking lot in Florida?": "The sequence of events began when Henry Brown hid in his estranged wife's trunk until she left the restaurant. Upon leaving the restaurant, Chericia was attacked and stabbed multiple times by Henry. After the attack, Henry changed vehicles and picked up his two children from the babysitter. He then headed to Central Florida Regional Hospital in search of his wife, and opened fire on law enforcement and security personnel in an attempt to flee. He was later discovered by police near the Seminole-Volusia county line. Upon closing in to arrest him, they found him as well as his two children dead inside. Investigators believe Brown killed his children at some point after picking them up, then committed suicide while police prepared to apprehend him. Chericia died at the hospital from her injuries.", "What are the main sources of Berlin's total 1992 budget?": "Berlin's total 1992 budget comes from 38 percent in subsidies from the German government, 13 percent through new borrowing, and 26 percent through taxes.", 'What was the subject of the program given by Suffolk University Law School’s Intellectual Property section on Monday, February 04, 2019?': 'The subject of the program given by Suffolk University Law School’s Intellectual Property section was the public domain, in celebration of the fact that, for the first time in 20 years, works have started to age out of copyright coverage.', 'What are some strategies to improve the efficiency and effectiveness of a call center staff?': 'Some strategies include ensuring customer service representatives understand the products or services they are discussing, creating templatized responses for popular questions, considering an automated answering service, and trying a virtual answering service.', 'What is the author planning to reveal on November 2nd for her novel The Newstead Project?': 'The author is planning to reveal the cover of her novel The Newstead Project, the book trailer, and swag.', 'What is a "foster failure" in the context of animal rescue?': 'A "foster failure" in the context of animal rescue refers to when animal rescuers end up adopting a dog they initially planned to house on a temporary basis.', 'What are some of the criticisms mentioned about providing iPads to MPs in the House of Commons?': "The criticisms include the high cost of iPads, their unsuitability as office equipment due to the lack of a physical keyboard, limited battery life, lack of support for flash, inability to make phone calls or take pictures, and the need to sync media files through iTunes. It is also mentioned that the most affordable model only has WiFi and that the iPads would not improve productivity or save paper as intended. The text also criticizes the decision as a waste of taxpayers' money.", 'Where does Thomas Kosmala source his ingredients for his fragrances?': 'Thomas Kosmala sources his ingredients from all over the world, however they are processed at his factory in France.', 'What is the impact of sleep disturbances on the biological aging of postmenopausal women according to a study?': "According to the study, postmenopausal women with 5 insomnia symptoms were nearly 2 years older biologically than similar women with no insomnia symptoms. The more insomnia symptoms, the greater the effect. However, sleeping only 6 hours a night doesn't seem to increase the epigenetic age if the sleep is restful.", 'What are some of the benefits of becoming a Friend of the theatre?': 'Some of the benefits of becoming a Friend of the theatre include great ticket savings, priority booking, access to a Friends Hotline, and invitations to special events. Additionally, Friends make a direct charitable contribution to community, education and artistic programmes through Hippodrome Projects.', 'What is the original phrase that was later changed to "life, liberty, and the pursuit of happiness"?': 'The original phrase was "life, liberty, and the pursuit of property."', 'What are some of the recommended dishes at the Dinner Bell at the Wildcatter?': 'The recommended dishes at the Dinner Bell at the Wildcatter include steaks, eggrolls, and the blueberry crisp.', 'Why does Mauricio Pochettino say he could never coach Barcelona?': 'Mauricio Pochettino says he could never coach Barcelona because he would feel like a traitor to himself and he believes in remaining true to his own values.', 'Who was let go after not responding to an email offering to extend his employment?': 'Nicholas Allegra.', 'What are some features of the Web-tex Northern Ireland Gloves?': 'The Web-tex Northern Ireland Gloves are black leather gloves with features such as padded knuckles, knitted cuffs with lining, and are made to military specification. They also have a leather outer and are available in various sizes.', "Who was Aaron Pryor's manager during his boxing career?": "Aaron Pryor's manager was Buddy LaRosa, founder of LaRosa's Pizzeria.", 'What are the three main parts of Quality SEO?': 'The three main parts of Quality SEO are Structural Optimization, Content Creation, and Link Building.', 'What was the purpose of the study conducted by J.L. Hamby in 1995?': 'The purpose of the study was to compare the Applied Biology/Chemistry (ABC) curriculum taught using the cooperative learning method with the traditional biology curriculum taught using more typical instruction by means of student scores on a standardized biology test and science attitude survey.', 'What is suggested as a way to show sisterly love and connection in a unique and stylish manner?': 'Getting matching tattoos is suggested as a unique and stylish way to show sisterly love and connection.', 'What does the name Madigan mean in Irish?': 'Madigan means “small dog” in Irish.', "What is the author's opinion on the actions of PFC Bradley Manning and Edward Snowden?": 'The author does not agree with what Manning and Snowden did in revealing classified information. However, the author respects individuals who act on their convictions despite knowing the consequences. The author believes that Manning, by facing court-martial, may do more to further his views than Snowden, who is trying to avoid the consequences of his actions.', "What was the percentage of income earned by the top 1 percent of Americans in 2007 according to Sanders' claim?": "The top 1 percent of all income earners in the United States made 23.5 percent of all income in 2007 according to Sanders' claim.", 'What are the four phenomenological constants described by Schön that could form a matrix for reflective practice within interdisciplinary research contexts?': 'The four phenomenological constants are: The media, languages, and repertoires that practitioners use to describe reality and conduct experiments; The appreciative systems they bring to problem setting, to the evaluation of inquiry, and to reflective conversation; The overarching theories by which they make sense of phenomena; The role frames within which they set their tasks and through which they bound their institutional settings.', 'What does the Advent wreath and its components symbolize in Christian tradition?': 'The circle of the Advent wreath, which has no beginning or end, symbolizes the eternity of God. The evergreen base represents God as the foundation of all good, with green symbolizing hope and new life. The four candles represent the four weeks of Advent, with the first two purple candles symbolizing Hope and Love, the third pink candle symbolizing Joy, and the fourth purple candle representing Peace. The light of the candles signifies the light of Christ to mankind.', 'Who claimed responsibility for the killing of a father-son duo allegedly for spying?': 'Anti-talk ULFA which is also known as ULFA (Independent) claimed responsibility for the incident.', 'Who is the most followed person on Instagram according to the context?': 'Selena Gomez is the most followed person on Instagram.', "Who is Karen Stintz and what position is she aiming for in Toronto's municipal government?": 'Karen Stintz is a three-term municipal politician representing Eglinton-Lawrence, and chair of the Toronto Transit Commission (TTC). She is aiming for the position of Mayor of Toronto.', 'How did the person hang the background paper in the garage?': 'The person used C clamps to attach the background paper to the top of the garage door. They used an old bar to hold the roll of paper and the "c" part of the two C clamps. Later, they built a piece of wood with holes in it, hung the rolls on a length of PVC pipe, and capped the end. The setup was still held on by C Clamps.', 'What did the woman name her baby to compensate for the lack of royalty?': 'She named the baby Elvis.', 'What is the routine of an Early Intervention Specialist/Service Coordinator for babies with developmental delays and/or disorders?': "The routine of an Early Intervention Specialist/Service Coordinator involves receiving a referral from a family, pediatrician, or hospital, usually concerning a developmental issue like speech/language. They call the family, explain the program, gather the child's birth/medical history, and understand the parent's specific concerns. They then discuss the child's behavior and hearing abilities, and explain the importance of a formal hearing exam. They also discuss language development expectations for the child's age. Based on the concerns, they schedule evaluations with a speech therapist and a developmental specialist. They coordinate with several people to find the best time for the evaluation, considering the child's nap schedules, feeding times, and parents' work schedule. They also provide the family with other resources if necessary, such as potty training suggestions, pediatrician recommendations, daycare or childcare options, and help with insurance coverage.", 'What was the first job Edwin Koo landed in his professional career?': "Edwin Koo's first job in his professional career was as a photojournalist in local newspapers Streats, and then The Straits Times.", 'What does inclusive growth mean according to Montek Singh Ahluwalia, Deputy Chairman, Planning Commission?': 'According to Montek Singh Ahluwalia, inclusive growth means much more than poverty reduction. It should factor in issues of equity, both inter-generational and between rich and poor, regional inequities and the needs of minorities.', 'What violation did Iglesia Cristiana Ebenezer of Greenville, TX, licensee of Station KYLP-LP, commit according to the Notice of Apparent Liability for Forfeiture and Order?': "Iglesia Cristiana Ebenezer of Greenville, TX, licensee of Station KYLP-LP, violated Section 11.35(a) of the Commission's rules by failing to install Emergency Alert System (EAS) equipment and maintain EAS logs.", 'What is the main concern of the individual in the context about their job title?': 'The main concern of the individual is that they are labeled as an "A" while everyone else is a "B". They believe this is due to their lack of participation in meetings and their social anxiety. They worry that one day they might confront their manager about this difference in job title.', 'What is the maximum cash offer that the car wreckers in Roleystone can provide for junk cars?': 'The maximum cash offer that the car wreckers in Roleystone can provide for junk cars is up to $9,999.', "What was the innovative approach of AUNE's Department of Clinical Psychology when it was launched thirty years ago?": "The innovative approach of AUNE's Department of Clinical Psychology was to educate psychologists as practitioner-scholars, well-rounded clinicians with a broad range of skills and competencies who would be integrated into their communities. This ran counter to the typical doctoral program of the day which trained people in narrow research areas, with an academic rather than practical focus. It put AUNE at the leading edge of an emerging Doctor of Psychology (PsyD) movement which emphasized preparing graduates for clinical practice as a primary focus.", 'What are some of the features of the Doro PhoneEasy 618?': 'The Doro PhoneEasy 618 has an In Case of Emergency menu where you can list personal and medical information, a LED light that can be used as a flashlight, an FM radio, and a 3.2-megapixel camera with auto-focus, LED flash, and digital zoom. It also allows for text messaging, though the process is a bit cumbersome. However, it lacks the ability to record video and share photos online.', 'What are some of the features of the Vegan Oriental Dishes cookbook?': 'The Vegan Oriental Dishes cookbook contains 150 healthy oriental dishes including Stir-Fry Dishes, Korean Dishes, Chinese Dishes, Thai Dishes, Japanese Dishes, and Filipino Dishes. It is Cholesterol-Free, High in Fiber, High in Omega-3, and High in Soy. The cookbook contains No Eggs, No Dairy, No MSG and No Animal Products. It also provides simple and easy recipes that use healthy ingredients.', 'What is the main theme of the book "The Healing Power of the Sacred Woman"?': 'The main theme of the book "The Healing Power of the Sacred Woman" is to remind women to reconnect to the potent and creative energy of Mother Earth, which gives power to the intuitive voice of the heart and nurtures new seeds of inspiration and enlightenment through the womb. It emphasizes that a woman\'s purpose is to give birth not only to new life but also to new levels of consciousness.', 'Who has granted a 5 year lease on the C.S.M. Memorial Ground to the rugby club?': 'The Camborne School of Mines Trustees have granted a 5 year lease on the C.S.M. Memorial Ground to the rugby club.', 'What is the advice given to hosts who serve alcohol at their parties according to the New York Insurance Association?': "The New York Insurance Association advises hosts who serve alcohol to take steps to limit their liquor liability and make sure they have the proper insurance. They also need to be particularly careful as they can be held legally responsible for their guests' actions after they leave the party.", 'What is the concern of the husband of the person who wrote the message on July 10, 2011?': 'The husband is very concerned about the possible health hazard posed by smart meter.', 'When and where was UFC 142 held?': 'UFC 142 was held in Brazil on Jan. 14.'}



instruction = (
    "Please provide a short and precise answer based only on verified and factual information. "
    "Avoid speculation or assumptions. Do not elaborate beyond what is necessary to directly answer the question."
    "Do not repeat yourself"
    "Do not truncate sentences"
)

# Session state
if "messages" not in st.session_state:
    st.session_state.messages = []

st.header("General Purpose Chat with LLama")
st.write("This first part of the web app is simply a chatbot powered by the Llama model")

# Chat history
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

if prompt := st.chat_input("What is up?"):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    messages_payload = [{"role": "system", "content": "You are a helpful assistant."}]
    for msg in st.session_state.messages:
        messages_payload.append({"role": msg["role"], "content": msg["content"]})

    payload = {
        "model": model_id,
        "messages": messages_payload,
        "temperature": 0.7,
        "top_p": 0.9,
        "repetition_penalty": 1.1,
        "top_k": 40,
        "max_tokens": 1024,
        "stream": False
    }

    response = requests.post(api_url, headers=headers, data=json.dumps(payload))

    if response.status_code == 200:
        result = response.json()
        assistant_reply = result['choices'][0]['message']['content'].strip()

        with st.chat_message("assistant"):
            st.markdown(assistant_reply)
        st.session_state.messages.append({"role": "assistant", "content": assistant_reply})
    else:
        st.error(f"Error: {response.status_code} - {response.text}")

# Second part
st.markdown("---")
st.header("Compare Llama responses with a RAG response")
st.write("This second part of the web app compares responses generated by the Llama model with the responses obtained doing RAG that are stored on the dataset")
if st.button("Choose random question"):
    question, reference_answer = random.choice(list(qa_dataset.items()))
    st.markdown(f"**Selected Question:** {question}")

    messages_payload = [
        {"role": "system", "content": instruction},
        {"role": "user", "content": question}
    ]

    payload = {
        "model": model_id,
        "messages": messages_payload,
        "temperature": 0.7,
        "top_p": 0.9,
        "repetition_penalty": 1.1,
        "top_k": 40,
        "max_tokens": 512,
        "stream": False
    }

    response = requests.post(api_url, headers=headers, data=json.dumps(payload))

    if response.status_code == 200:
        result = response.json()
        llama_answer = result['choices'][0]['message']['content'].strip()

        col1, col2 = st.columns(2)
        with col1:
            st.subheader("Llama's Answer")
            st.markdown(llama_answer)
        with col2:
            st.subheader("Neural Bridge Dataset Answer")
            st.markdown(reference_answer)
    else:
        st.error(f"Error: {response.status_code} - {response.text}")
